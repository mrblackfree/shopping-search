import { 
  createStealthBrowser, 
  createStealthPage, 
  randomDelay, 
  waitForAnySelector, 
  scrollToLoadContent,
  retryWithBackoff,
  getRandomUserAgent
} from '../playwright-utils';
import { Product, SearchResult } from '../types';
import { convertToKRW } from '../exchange';

export async function searchAlibaba(keyword: string): Promise<SearchResult> {
  const startTime = Date.now();
  
  return await retryWithBackoff(async () => {
    const browser = await createStealthBrowser();
    let page;
    
    try {
      console.log('üîç Alibaba Í≤ÄÏÉâ ÏãúÏûë:', keyword);
      
      page = await createStealthPage(browser);
      
      // Alibaba Ï†ÑÏö© ÏÑ§Ï†ï
      await page.addInitScript(() => {
        Object.defineProperty(navigator, 'userAgent', {
          get: () => 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
        });
        
        // Ï∂îÍ∞Ä Î¥á Í∞êÏßÄ Ïö∞Ìöå
        Object.defineProperty(navigator, 'webdriver', {
          get: () => undefined,
        });
        
        Object.defineProperty(navigator, 'plugins', {
          get: () => [1, 2, 3, 4, 5],
        });
      });

      const searchUrl = `https://www.alibaba.com/trade/search?SearchText=${encodeURIComponent(keyword)}`;
      
      // ÌéòÏù¥ÏßÄ Î°úÎìú (Îçî Í∏¥ ÌÉÄÏûÑÏïÑÏõÉ)
      await page.goto(searchUrl, { 
        waitUntil: 'networkidle', 
        timeout: 45000 
      });

      // ÏûêÏó∞Ïä§Îü¨Ïö¥ ÎîúÎ†àÏù¥
      await randomDelay(4000, 7000);

      // Ï∫°Ï∞®ÎÇò Ï∞®Îã® ÌéòÏù¥ÏßÄ ÌôïÏù∏
      const isBlocked = await page.evaluate(() => {
        const url = window.location.href;
        const title = document.title;
        return url.includes('punish') || 
               url.includes('captcha') || 
               title.includes('Access Denied') || 
               title.includes('Captcha') ||
               document.body.textContent?.includes('Please verify you are human');
      });

      if (isBlocked) {
        console.log('‚ö†Ô∏è Alibaba Î¥á Í∞êÏßÄ - Îã§Î•∏ Î∞©Î≤ï ÏãúÎèÑ');
        throw new Error('Alibaba bot detection triggered');
      }

      // ÏÉÅÌíà Î¶¨Ïä§Ìä∏Í∞Ä Î°úÎìúÎê† ÎïåÍπåÏßÄ ÎåÄÍ∏∞
      const productSelectors = [
        '.organic-list-item',
        '.gallery-offer-item',
        '.list-no-v2-item',
        '.product-item',
        '[data-spm-anchor-id]'
      ];

      const foundSelector = await waitForAnySelector(page, productSelectors, 20000);
      
      if (!foundSelector) {
        // Ïä§ÌÅ¨Î°§ÌïòÏó¨ ÎèôÏ†Å ÏΩòÌÖêÏ∏† Î°úÎìú ÏãúÎèÑ
        console.log('ÏÉÅÌíà Î¶¨Ïä§Ìä∏ Î°úÎî© Ï§ë... Ïä§ÌÅ¨Î°§ ÏãúÎèÑ');
        await scrollToLoadContent(page);
        await randomDelay(3000, 5000);
      }

      // ÏÉÅÌíà Ï†ïÎ≥¥ Ï∂îÏ∂ú
      const products = await page.evaluate(() => {
        const productElements = document.querySelectorAll('.organic-list-item, .gallery-offer-item, .list-no-v2-item, .product-item, [data-spm-anchor-id]');
        const results: any[] = [];

        console.log(`Î∞úÍ≤¨Îêú ÏÉÅÌíà ÏöîÏÜå Ïàò: ${productElements.length}`);

        productElements.forEach((element, index) => {
          if (index >= 5) return; // ÏÉÅÏúÑ 5Í∞úÎßå

          try {
            // Ï†úÎ™© Ï∂îÏ∂ú (Ïó¨Îü¨ ÏÖÄÎ†âÌÑ∞ ÏãúÎèÑ)
            const titleSelectors = [
              '.elements-title-normal__content',
              '.organic-offer-title',
              '.title',
              'h2',
              'h3',
              'a[title]'
            ];
            
            let title = '';
            let productUrl = '';
            for (const selector of titleSelectors) {
              const titleEl = element.querySelector(selector) as HTMLAnchorElement;
              if (titleEl) {
                title = titleEl.textContent?.trim() || titleEl.getAttribute('title')?.trim() || '';
                productUrl = titleEl.href || '';
                if (title) break;
              }
            }

            // Í∞ÄÍ≤© Ï∂îÏ∂ú
            const priceSelectors = [
              '.price-current',
              '.price-now',
              '.price',
              '.cost'
            ];
            
            let priceText = '';
            for (const selector of priceSelectors) {
              const priceEl = element.querySelector(selector);
              if (priceEl) {
                priceText = priceEl.textContent?.trim() || '';
                if (priceText) break;
              }
            }

            // Ïù¥ÎØ∏ÏßÄ Ï∂îÏ∂ú
            const imgSelectors = [
              '.organic-offer-image img',
              '.product-image img',
              'img'
            ];
            
            let imageUrl = '';
            for (const selector of imgSelectors) {
              const imgEl = element.querySelector(selector) as HTMLImageElement;
              if (imgEl) {
                imageUrl = imgEl.src || imgEl.getAttribute('data-src') || '';
                if (imageUrl && !imageUrl.includes('placeholder')) break;
              }
            }

            // ÌåêÎß§Ïûê Ï†ïÎ≥¥
            const sellerSelectors = ['.supplier-name', '.seller-name', '.company-name'];
            let sellerName = '';
            for (const selector of sellerSelectors) {
              const sellerEl = element.querySelector(selector);
              if (sellerEl) {
                sellerName = sellerEl.textContent?.trim() || '';
                if (sellerName) break;
              }
            }

            // MOQ (ÏµúÏÜå Ï£ºÎ¨∏Îüâ) Ï∂îÏ∂ú
            const moqSelectors = ['.min-order', '.moq', '.minimum-order'];
            let minOrderText = '';
            for (const selector of moqSelectors) {
              const moqEl = element.querySelector(selector);
              if (moqEl) {
                minOrderText = moqEl.textContent?.trim() || '';
                if (minOrderText) break;
              }
            }

            if (title && priceText) {
              // Í∞ÄÍ≤© ÌååÏã± ($1.50-$2.30 ÌòïÌÉú)
              const priceMatch = priceText.match(/\$?([\d.,]+)/);
              const price = priceMatch ? parseFloat(priceMatch[1].replace(',', '')) : 0;

              // MOQ ÌååÏã±
              const moqMatch = minOrderText.match(/(\d+)/);
              const minOrder = moqMatch ? parseInt(moqMatch[1]) : 1;

              if (price > 0) {
                results.push({
                  id: `alibaba_${index}`,
                  title,
                  price,
                  currency: 'USD',
                  imageUrl: imageUrl ? (imageUrl.startsWith('http') ? imageUrl : `https:${imageUrl}`) : '',
                  productUrl: productUrl ? (productUrl.startsWith('http') ? productUrl : `https://www.alibaba.com${productUrl}`) : '',
                  seller: {
                    name: sellerName,
                    trustLevel: 'Medium'
                  },
                  site: 'alibaba',
                  minOrder,
                  shipping: 'Contact Supplier'
                });
              }
            }
          } catch (error) {
            console.error(`ÏÉÅÌíà ${index} ÌååÏã± Ïò§Î•ò:`, error);
          }
        });

        return results;
      });

      // KRW Î≥ÄÌôò
      const productsWithKRW = await Promise.all(
        products.map(async (product: any) => ({
          ...product,
          priceKRW: await convertToKRW(product.price, 'USD')
        }))
      );

      console.log(`‚úÖ AlibabaÏóêÏÑú ${productsWithKRW.length}Í∞ú ÏÉÅÌíà Î∞úÍ≤¨`);
      
      return {
        query: keyword,
        totalResults: productsWithKRW.length,
        products: productsWithKRW,
        site: 'alibaba',
        searchTime: Date.now() - startTime
      };

    } catch (error) {
      console.error('‚ùå Alibaba Í≤ÄÏÉâ Ïò§Î•ò:', error);
      return {
        query: keyword,
        totalResults: 0,
        products: [],
        site: 'alibaba',
        searchTime: Date.now() - startTime
      };
    } finally {
      if (page) await page.close();
      await browser.close();
    }
  }, 2, 2000); // Ïû¨ÏãúÎèÑ 2Ìöå, 2Ï¥à Í∞ÑÍ≤©
}

export async function analyzeAlibabaProduct(url: string): Promise<any> {
  return await retryWithBackoff(async () => {
    const browser = await createStealthBrowser();
    let page;
    
    try {
      console.log('üîç Alibaba ÏÉÅÌíà Î∂ÑÏÑù:', url);
      
      page = await createStealthPage(browser);
      
      await page.goto(url, { 
        waitUntil: 'networkidle', 
        timeout: 45000 
      });

      await randomDelay(4000, 7000);

      // Ï∫°Ï∞® ÌôïÏù∏
      const isBlocked = await page.evaluate(() => {
        const url = window.location.href;
        return url.includes('punish') || url.includes('captcha');
      });

      if (isBlocked) {
        throw new Error('Alibaba product page blocked');
      }

      const productData = await page.evaluate(() => {
        // Ï†úÎ™© Ï∂îÏ∂ú
        const titleSelectors = [
          '.product-title h1',
          '.product-name',
          'h1',
          '.title'
        ];
        
        let title = '';
        for (const selector of titleSelectors) {
          const el = document.querySelector(selector);
          if (el) {
            title = el.textContent?.trim() || '';
            if (title) break;
          }
        }

        // Í∞ÄÍ≤© Ï∂îÏ∂ú
        const priceSelectors = [
          '.price-current',
          '.price-now',
          '.price-range',
          '.price'
        ];
        
        let priceText = '';
        for (const selector of priceSelectors) {
          const el = document.querySelector(selector);
          if (el) {
            priceText = el.textContent?.trim() || '';
            if (priceText) break;
          }
        }

        // ÏÑ§Î™Ö Ï∂îÏ∂ú
        const descSelectors = [
          '.product-description',
          '.product-detail',
          '.description'
        ];
        
        let description = '';
        for (const selector of descSelectors) {
          const el = document.querySelector(selector);
          if (el) {
            description = el.textContent?.trim() || '';
            if (description) break;
          }
        }

        // ÌåêÎß§Ïûê Ï†ïÎ≥¥
        const sellerSelectors = [
          '.supplier-name',
          '.company-name',
          '.seller-name'
        ];
        
        let sellerName = '';
        for (const selector of sellerSelectors) {
          const el = document.querySelector(selector);
          if (el) {
            sellerName = el.textContent?.trim() || '';
            if (sellerName) break;
          }
        }

        // Ïù¥ÎØ∏ÏßÄ ÏàòÏßë
        const imageUrls: string[] = [];
        const imgElements = document.querySelectorAll('.product-gallery img, .product-images img');
        imgElements.forEach(img => {
          const src = (img as HTMLImageElement).src || img.getAttribute('data-src');
          if (src && !src.includes('placeholder')) {
            imageUrls.push(src.startsWith('//') ? `https:${src}` : src);
          }
        });

        const priceMatch = priceText.match(/\$?([\d.,]+)/);
        const price = priceMatch ? parseFloat(priceMatch[1].replace(',', '')) : 0;

        return {
          title,
          description,
          price,
          currency: 'USD',
          seller: {
            name: sellerName
          },
          site: 'alibaba',
          imageUrls,
          originalUrl: window.location.href
        };
      });

      const finalProductData = {
        ...productData,
        priceKRW: productData.price > 0 ? await convertToKRW(productData.price, 'USD') : 0
      };

      console.log('‚úÖ Alibaba ÏÉÅÌíà Î∂ÑÏÑù ÏôÑÎ£å');
      return finalProductData;

    } catch (error) {
      console.error('‚ùå Alibaba ÏÉÅÌíà Î∂ÑÏÑù Ïò§Î•ò:', error);
      throw new Error('Alibaba ÏÉÅÌíà Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
    } finally {
      if (page) await page.close();
      await browser.close();
    }
  }, 2, 2000);
} 